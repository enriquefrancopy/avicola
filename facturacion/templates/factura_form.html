{% extends 'base.html' %}
{% load humanize custom_filters %}

{% block title %}{{ titulo }} - Avícola CVA{% endblock %}

{% block page_title %}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'factura_list' %}?tipo={{ tipo }}">Facturas</a></li>
<li class="breadcrumb-item active">{{ titulo }}</li>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0"><i class="bi bi-plus-circle"></i> {{ titulo }}</h4>
    </div>
    <div class="card-body">
      <form method="post" id="facturaForm">
        {% csrf_token %}
        
        <!-- Información básica de la factura -->
        <div class="row mb-4">
          
          <!-- Campos ocultos para tipo y número -->
          <input type="hidden" name="tipo" value="{{ tipo }}">
          <input type="hidden" name="numero" value="">
          <input type="hidden" name="fecha" value="{{ fecha_actual }}">
          <input type="hidden" name="id_detalles-TOTAL_FORMS" id="id_detalles-TOTAL_FORMS" value="0">
          
          <div class="col-md-12">
            <label class="form-label" id="label-proveedor-cliente">
              {% if tipo == 'compra' %}Proveedor{% else %}Cliente{% endif %}
            </label>
            {% if tipo == 'compra' %}
              <div class="position-relative">
                <input type="text" id="proveedor_search" class="form-control" placeholder="Buscar proveedor..." autocomplete="off">
                <input type="hidden" name="proveedor" id="proveedor_id">
                <div id="proveedor_results" class="dropdown-menu w-100 position-absolute" style="max-height: 200px; overflow-y: auto; z-index: 1000;"></div>
              </div>
            {% else %}
              <div class="position-relative">
                <input type="text" id="cliente_search" class="form-control" placeholder="Buscar cliente..." autocomplete="off">
                <input type="hidden" name="cliente" id="cliente_id">
                <div id="cliente_results" class="dropdown-menu w-100 position-absolute" style="max-height: 200px; overflow-y: auto; z-index: 1000;"></div>
              </div>
            {% endif %}
          </div>
        </div>
        
        <!-- Detalles de la factura -->
        <div class="row mb-4">
            <!-- Carga Rápida Integrada -->
            <div class="card bg-light mb-3">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <label class="form-label">Buscar Producto</label>
                    <input type="text" id="carga-rapida-search" class="form-control" placeholder="Escriba el código o nombre del producto...">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Cantidad</label>
                    <input type="number" id="carga-rapida-cantidad" class="form-control" value="1" min="1">
                  </div>
                </div>
                
                <!-- Resultados de búsqueda -->
                <div id="resultados-busqueda" class="mt-3" style="display: none;">
                  <div class="table-responsive">
                    <table class="table table-sm table-hover">
                      <thead class="table-light">
                        <tr>
                          <th>Código</th>
                          <th>Producto</th>
                          <th>{% if tipo == 'compra' %}Costo{% else %}Precio{% endif %}</th>
                          {% if tipo == 'compra' %}
                          <th>Precio Venta</th>
                          {% endif %}
                          <th>Stock</th>
                          <th>Acciones</th>
                        </tr>
                      </thead>
                      <tbody id="carga-rapida-tbody">
                        <!-- Los productos se cargarán aquí dinámicamente -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <!-- Lista de productos agregados -->
            <div class="card">
              <div class="card-header bg-dark text-white" style="margin: -1rem -1rem 1rem -1rem; padding: 1rem;">
                <div class="row">
                  <div class="col-md-{% if tipo == 'compra' %}3{% else %}4{% endif %} text-center">
                    <strong>Producto</strong>
                  </div>
                  <div class="col-md-2 text-end">
                    <strong>Cantidad</strong>
                  </div>
                  <div class="col-md-2 text-end">
                    <strong>{% if tipo == 'compra' %}Costo{% else %}Precio{% endif %}</strong>
                  </div>
                  {% if tipo == 'compra' %}
                  <div class="col-md-2 text-end">
                    <strong>Precio Venta</strong>
                  </div>
                  <div class="col-md-2 text-end">
                    <strong>Total</strong>
                  </div>
                  {% endif %}
                  {% if tipo != 'compra' %}
                  <div class="col-md-2 text-center">
                     <strong>Subtotal 5%</strong>
                   </div>
                   <div class="col-md-2 text-center">
                     <strong>Subtotal 10%</strong>
                   </div>
                  {% endif %}
                </div>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <tbody id="detalles-container">
                      <!-- Los productos se agregarán aquí dinámicamente -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        <!-- Totales -->
        <div class="row mb-4">
          <div class="col-md-12">
            <div class="row">
              {% if tipo != 'compra' %}
              <!-- Tarjeta de IVA -->
              <div class="col-md-6">
                <div class="card bg-light">
                  <div class="card-body">
                    <div class="row">
                      <div class="col-4">
                        <strong>IVA 5%:</strong> <span id="total-iva-5" class="float-end">Gs. 0</span>
                    </div>
                      <div class="col-4">
                        <strong>IVA 10%:</strong> <span id="total-iva-10" class="float-end">Gs. 0</span>
                </div>
                      <div class="col-4">
                        <strong>Total IVA:</strong> <span id="total-iva" class="float-end h6">Gs. 0</span>
              </div>
            </div>
          </div>
          </div>
        </div>
        
              <!-- Tarjeta de Total -->
              <div class="col-md-6">
            <div class="card bg-light">
              <div class="card-body">
                <div class="row">
                  <div class="col-6">
                        <strong>Subtotal 5%:</strong> <span id="total-subtotal-5" class="float-end">Gs. 0</span>
                  </div>
                  <div class="col-6">
                        <strong>Subtotal 10%:</strong> <span id="total-subtotal-10" class="float-end">Gs. 0</span>
                  </div>
                </div>
                <hr>
                <div class="row">
                      <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                          <strong class="h5 mb-0 fw-bold">Total General:</strong>
                          <span id="total-general" class="h5 mb-0 fw-bold">Gs. 0</span>
                        </div>
                  </div>
                    </div>
                  </div>
                </div>
              </div>
              {% else %}
              <!-- Tarjeta de Total para Compras -->
              <div class="col-md-12">
                <div class="card bg-light">
                  <div class="card-body">
                    <div class="row">
                      <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                          <strong class="h5 mb-0 fw-bold">Total General:</strong>
                          <span id="total-general" class="h5 mb-0 fw-bold">Gs. 0</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        
        <!-- Botones de acción -->
        <div class="row">
          <div class="col-md-12 d-flex justify-content-end">
            <a href="{% url 'factura_list' %}?tipo={{ tipo }}" class="btn btn-secondary me-2">
              <i class="bi bi-arrow-left"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-success">
              <i class="bi bi-check-circle"></i> Guardar Factura
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para crear nuevo proveedor -->
<div class="modal fade" id="modalCrearProveedor" tabindex="-1" aria-labelledby="modalCrearProveedorLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalCrearProveedorLabel">
          <i class="bi bi-plus-circle"></i> Crear Nuevo Proveedor
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="formCrearProveedor">
          <div class="mb-3">
            <label for="nuevo_nombre" class="form-label">Nombre *</label>
            <input type="text" class="form-control" id="nuevo_nombre" required>
          </div>
          <div class="mb-3">
            <label for="nuevo_rif" class="form-label">RIF/RUC *</label>
            <input type="text" class="form-control" id="nuevo_rif" required>
          </div>
          <div class="mb-3">
            <label for="nuevo_direccion" class="form-label">Dirección</label>
            <textarea class="form-control" id="nuevo_direccion" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label for="nuevo_telefono" class="form-label">Teléfono</label>
            <input type="text" class="form-control" id="nuevo_telefono">
          </div>
          <div class="mb-3">
            <label for="nuevo_email" class="form-label">Email</label>
            <input type="email" class="form-control" id="nuevo_email">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnGuardarProveedor">
          <i class="bi bi-check-circle"></i> Guardar Proveedor
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para crear nuevo cliente -->
<div class="modal fade" id="modalCrearCliente" tabindex="-1" aria-labelledby="modalCrearClienteLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalCrearClienteLabel">
          <i class="bi bi-plus-circle"></i> Crear Nuevo Cliente
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="formCrearCliente">
          <div class="mb-3">
            <label for="nuevo_cliente_nombre" class="form-label">Nombre *</label>
            <input type="text" class="form-control" id="nuevo_cliente_nombre" required>
          </div>
          <div class="mb-3">
            <label for="nuevo_cliente_rif" class="form-label">RIF/RUC *</label>
            <input type="text" class="form-control" id="nuevo_cliente_rif" required>
          </div>
          <div class="mb-3">
            <label for="nuevo_cliente_direccion" class="form-label">Dirección</label>
            <textarea class="form-control" id="nuevo_cliente_direccion" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label for="nuevo_cliente_telefono" class="form-label">Teléfono</label>
            <input type="text" class="form-control" id="nuevo_cliente_telefono">
          </div>
          <div class="mb-3">
            <label for="nuevo_cliente_email" class="form-label">Email (opcional)</label>
            <input type="email" class="form-control" id="nuevo_cliente_email" placeholder="ejemplo@email.com">
            <div class="form-text">Si no proporciona un email, se generará uno automáticamente.</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnGuardarCliente">
          <i class="bi bi-check-circle"></i> Guardar Cliente
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Función para esperar a que jQuery se cargue
function waitForJQuery(callback) {
  if (typeof jQuery !== 'undefined') {
    callback();
  } else {
    setTimeout(function() {
      waitForJQuery(callback);
    }, 100);
  }
}

// Esperar a que jQuery esté disponible antes de ejecutar el código
waitForJQuery(function() {
  var $ = jQuery;
  
  $(document).ready(function() {
    
    // Autocompletado de proveedores
    $('#proveedor_search').on('input', function() {
      const query = $(this).val();
      
      if (query.length >= 2) {
        $.ajax({
          url: '{% url "buscar_proveedores" %}',
          method: 'GET',
          data: {q: query},
          dataType: 'json',
          success: function(data) {
            const results = $('#proveedor_results');
            results.empty();
            
            if (data && data.length > 0) {
              data.forEach(function(proveedor) {
                results.append(`
                  <a class="dropdown-item" href="#" data-id="${proveedor.id}" data-nombre="${proveedor.nombre}">
                    ${proveedor.nombre} (${proveedor.rif})
                  </a>
                `);
              });
              results.show();
            } else {
              results.append(`
                <div class="dropdown-item text-muted">No se encontraron proveedores</div>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item text-primary" href="#" id="crear-proveedor-btn">
                  <i class="bi bi-plus-circle"></i> Crear nuevo proveedor
                </a>
              `);
              results.show();
            }
          },
          error: function(xhr, status, error) {
            $('#proveedor_results').hide();
          }
        });
      } else {
        $('#proveedor_results').hide();
      }
    });

    // Seleccionar primer proveedor al presionar Enter
    $('#proveedor_search').on('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const firstResult = $('#proveedor_results .dropdown-item').first();
        if (firstResult.length > 0 && !firstResult.hasClass('text-muted')) {
          firstResult.click();
        }
      }
    });

    // Seleccionar proveedor
    $(document).on('click', '#proveedor_results .dropdown-item', function(e) {
      e.preventDefault();
      
      if ($(this).attr('id') === 'crear-proveedor-btn') {
        const busqueda = $('#proveedor_search').val();
        if (busqueda) {
          if (/[0-9]/.test(busqueda) && /[A-Za-z]/.test(busqueda)) {
            $('#nuevo_rif').val(busqueda);
          } else {
            $('#nuevo_nombre').val(busqueda);
          }
        }
        $('#modalCrearProveedor').modal('show');
        return;
      }
      
      const id = $(this).data('id');
      const nombre = $(this).data('nombre');
      $('#proveedor_search').val(nombre);
      $('#proveedor_id').val(id);
      $('#proveedor_results').hide();
    });
    
    // Autocompletado de clientes
    $('#cliente_search').on('input', function() {
      const query = $(this).val();
      if (query.length >= 2) {
        $.get('{% url "buscar_clientes" %}', {q: query})
          .done(function(data) {
            const results = $('#cliente_results');
            results.empty();
            if (data && data.length > 0) {
              data.forEach(function(cliente) {
                results.append(`
                  <a class="dropdown-item" href="#" data-id="${cliente.id}" data-nombre="${cliente.nombre}">
                    ${cliente.nombre} (${cliente.rif})
                  </a>
                `);
              });
              results.show();
            } else {
              results.append(`
                <div class="dropdown-item text-muted">No se encontraron clientes</div>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item text-primary" href="#" id="crear-cliente-btn">
                  <i class="bi bi-plus-circle"></i> Crear nuevo cliente
                </a>
              `);
              results.show();
            }
          })
          .fail(function(xhr, status, error) {
            $('#cliente_results').hide();
          });
      } else {
        $('#cliente_results').hide();
      }
    });

    // Seleccionar primer cliente al presionar Enter
    $('#cliente_search').on('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const firstResult = $('#cliente_results .dropdown-item').first();
        if (firstResult.length > 0 && !firstResult.hasClass('text-muted')) {
          firstResult.click();
        }
      }
    });

    // Seleccionar cliente
    $(document).on('click', '#cliente_results .dropdown-item', function(e) {
      e.preventDefault();
      
      if ($(this).attr('id') === 'crear-cliente-btn') {
        const busqueda = $('#cliente_search').val();
        if (busqueda) {
          if (/[0-9]/.test(busqueda) && /[A-Za-z]/.test(busqueda)) {
            $('#nuevo_cliente_rif').val(busqueda);
          } else {
            $('#nuevo_cliente_nombre').val(busqueda);
          }
        }
        $('#modalCrearCliente').modal('show');
        return;
      }
      
      const id = $(this).data('id');
      const nombre = $(this).data('nombre');
      $('#cliente_search').val(nombre);
      $('#cliente_id').val(id);
      $('#cliente_results').hide();
    });
    
    // Autocompletado de productos
    $(document).on('input', '.producto_search', function() {
      const query = $(this).val();
      const row = $(this).closest('.detalle-row');
      const results = row.find('.producto_results');
      const tipoFactura = '{{ tipo }}'; // Obtener el tipo de factura del template
      
      if (query.length >= 2) {
        $.get('{% url "buscar_productos" %}', {q: query, tipo: tipoFactura})
          .done(function(data) {
            results.empty();
            if (data && data.length > 0) {
              data.forEach(function(producto) {
                results.append(`
                  <a class="dropdown-item" href="#" data-id="${producto.id}" data-nombre="${producto.nombre}" data-precio="${producto.precio}" data-iva="${producto.iva}">
                    ${producto.nombre} (${producto.codigo}) - Gs. ${producto.precio.toLocaleString()} - IVA ${producto.iva}%
                  </a>
                `);
              });
              results.show();
            } else {
              results.append('<div class="dropdown-item text-muted">No se encontraron productos</div>');
              results.show();
            }
          })
          .fail(function(xhr, status, error) {
            results.hide();
          });
      } else {
        results.hide();
      }
    });

    // Seleccionar primer producto al presionar Enter
    $(document).on('keydown', '.producto_search', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const row = $(this).closest('.detalle-row');
        const firstResult = row.find('.producto_results .dropdown-item').first();
        if (firstResult.length > 0 && !firstResult.hasClass('text-muted')) {
          firstResult.click();
        }
      }
    });

    // Seleccionar producto
    $(document).on('click', '.producto_results .dropdown-item', function(e) {
      e.preventDefault();
      const row = $(this).closest('.detalle-row');
      const id = $(this).data('id');
      const nombre = $(this).data('nombre');
      const precio = $(this).data('precio');
      const iva = $(this).data('iva');
      
      row.find('.producto_search').val(nombre);
      row.find('.producto_id').val(id);
      row.find('.precio_unitario').val(precio);
      row.find('.iva_producto').val(iva);
      row.find('.producto_results').hide();
      
      calcularSubtotal(row);
      calcularTotales();
    });



    // Calcular totales con IVA discriminado
    function calcularTotales() {
      let totalSubtotal = 0;
      let totalSubtotal5 = 0;
      let totalSubtotal10 = 0;
      let totalIva5 = 0;
      let totalIva10 = 0;
      
      console.log('Calculando totales...');
      console.log('Filas encontradas:', $('.detalle-row').length);
      
      $('.detalle-row').each(function(index) {
        const cantidad = parseInt($(this).find('.cantidad').val()) || 0;
        const precio = parseInt($(this).find('.precio_unitario').val()) || 0;
        const iva = parseInt($(this).find('.iva_producto').val()) || 10;
        const subtotal = cantidad * precio;
        
        console.log(`Fila ${index + 1}: Cantidad=${cantidad}, Precio=${precio}, Subtotal=${subtotal}, IVA=${iva}%`);
        
        totalSubtotal += subtotal;
        
        // Calcular subtotales e IVA según el porcentaje del producto
        let subtotal5 = 0;
        let subtotal10 = 0;
        let iva5 = 0;
        let iva10 = 0;
        let totalFila = subtotal;
        
        if (iva === 5) {
          subtotal5 = subtotal;
          iva5 = Math.round(subtotal / 21);
          totalSubtotal5 += subtotal;
          totalIva5 += iva5;
          totalFila += iva5;
        } else if (iva === 10) {
          subtotal10 = subtotal;
          iva10 = Math.round(subtotal / 11);
          totalSubtotal10 += subtotal;
          totalIva10 += iva10;
          totalFila += iva10;
        }
        
        // Actualizar campos de la fila según el tipo de factura
        const tipoFactura = '{{ tipo }}';
        if (tipoFactura === 'compra') {
          $(this).find('.subtotal-compra').val(subtotal.toLocaleString());
        } else {
          $(this).find('.subtotal-5').val(subtotal5.toLocaleString());
          $(this).find('.subtotal-10').val(subtotal10.toLocaleString());
        }
      });
      
      const totalIva = totalIva5 + totalIva10;
      const totalSubtotalCompleto = totalSubtotal5 + totalSubtotal10;
      const totalGeneral = totalSubtotalCompleto; // Total es solo la suma de subtotales
      
      console.log('Total Subtotal 5%:', totalSubtotal5, 'Total Subtotal 10%:', totalSubtotal10, 'Total IVA 5%:', totalIva5, 'Total IVA 10%:', totalIva10);
      console.log('Total Subtotal Completo:', totalSubtotalCompleto, 'Total IVA:', totalIva, 'Total General:', totalGeneral);
      
      const tipoFactura = '{{ tipo }}';
      if (tipoFactura === 'compra') {
        $('#total-general').text('Gs. ' + totalSubtotal.toLocaleString());
      } else {
        $('#total-subtotal-5').text('Gs. ' + totalSubtotal5.toLocaleString());
        $('#total-subtotal-10').text('Gs. ' + totalSubtotal10.toLocaleString());
        $('#total-iva-5').text('Gs. ' + totalIva5.toLocaleString());
        $('#total-iva-10').text('Gs. ' + totalIva10.toLocaleString());
        $('#total-iva').text('Gs. ' + totalIva.toLocaleString());
        $('#total-general').text('Gs. ' + totalGeneral.toLocaleString());
      }
    }

    // Eventos para calcular totales y eliminar filas con cantidad 0
    $(document).on('input', '.cantidad, .precio_unitario, .precio_venta', function() {
      const row = $(this).closest('.detalle-row');
      const cantidad = parseInt($(this).val()) || 0;
      
      // Si la cantidad es 0, eliminar la fila
      if (cantidad === 0 && $('.detalle-row').length > 1) {
        row.remove();
        calcularTotales();
        return;
      }
      
      calcularTotales();
    });





    // Ocultar dropdowns al hacer clic fuera
    $(document).on('click', function(e) {
      if (!$(e.target).closest('.dropdown-menu, input').length) {
        $('.dropdown-menu').hide();
      }
    });

    // Guardar nuevo proveedor
    $('#btnGuardarProveedor').click(function() {
      const nombre = $('#nuevo_nombre').val().trim();
      const rif = $('#nuevo_rif').val().trim();
      const direccion = $('#nuevo_direccion').val().trim();
      const telefono = $('#nuevo_telefono').val().trim();
      const email = $('#nuevo_email').val().trim();
      
      if (!nombre || !rif) {
        alert('El nombre y RIF son obligatorios');
        return;
      }
      
      $.ajax({
        url: '{% url "proveedor_crear_ajax" %}',
        method: 'POST',
        data: {
          nombre: nombre,
          rif: rif,
          direccion: direccion,
          telefono: telefono,
          email: email,
          csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        },
        dataType: 'json',
        success: function(data) {
          if (data.success) {
            $('#proveedor_search').val(data.proveedor.nombre);
            $('#proveedor_id').val(data.proveedor.id);
            $('#proveedor_results').hide();
            $('#modalCrearProveedor').modal('hide');
            $('#formCrearProveedor')[0].reset();
            alert('Proveedor creado exitosamente');
          } else {
            alert('Error: ' + data.error);
          }
        },
        error: function(xhr, status, error) {
          alert('Error al crear el proveedor');
        }
      });
    });
    
    // Guardar nuevo cliente
    $('#btnGuardarCliente').click(function() {
      const nombre = $('#nuevo_cliente_nombre').val().trim();
      const rif = $('#nuevo_cliente_rif').val().trim();
      const direccion = $('#nuevo_cliente_direccion').val().trim();
      const telefono = $('#nuevo_cliente_telefono').val().trim();
      const email = $('#nuevo_cliente_email').val().trim();
      
      if (!nombre || !rif) {
        alert('El nombre y RIF son obligatorios');
        return;
      }
      
      // Validar formato de email si se proporciona
      if (email && !email.includes('@')) {
        alert('El email debe tener un formato válido (ejemplo: cliente@email.com)');
        return;
      }
      
      // Mostrar indicador de carga
      const btn = $(this);
      const originalText = btn.html();
      btn.html('<i class="bi bi-hourglass-split"></i> Guardando...').prop('disabled', true);
      
      $.ajax({
        url: '{% url "cliente_crear_ajax" %}',
        method: 'POST',
        data: {
          nombre: nombre,
          rif: rif,
          direccion: direccion,
          telefono: telefono,
          email: email,
          csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        },
        dataType: 'json',
        success: function(data) {
          if (data.success) {
            $('#cliente_search').val(data.cliente.nombre);
            $('#cliente_id').val(data.cliente.id);
            $('#cliente_results').hide();
            $('#modalCrearCliente').modal('hide');
            $('#formCrearCliente')[0].reset();
            
            // Mostrar mensaje de éxito más elegante
            const successAlert = $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
              '<i class="bi bi-check-circle"></i> Cliente "' + data.cliente.nombre + '" creado exitosamente' +
              '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
              '</div>');
            $('.container-fluid').first().prepend(successAlert);
            
            // Auto-ocultar después de 3 segundos
            setTimeout(function() {
              successAlert.alert('close');
            }, 3000);
          } else {
            alert('Error: ' + data.error);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error AJAX:', xhr.responseText);
          alert('Error al crear el cliente. Verifique la conexión e intente nuevamente.');
        },
        complete: function() {
          // Restaurar botón
          btn.html(originalText).prop('disabled', false);
        }
      });
    });



    // Carga rápida - Buscar productos
    $('#carga-rapida-search').on('input', function() {
      const query = $(this).val();
      const tbody = $('#carga-rapida-tbody');
      const resultadosDiv = $('#resultados-busqueda');
      const tipoFactura = '{{ tipo }}'; // Obtener el tipo de factura del template
      
      if (query.length >= 2) {
        $.get('{% url "buscar_productos" %}', {q: query, tipo: tipoFactura})
          .done(function(data) {
            tbody.empty();
            if (data && data.length > 0) {
              data.forEach(function(producto) {
                const tipoFactura = '{{ tipo }}';
                let precioVentaHtml = '';
                let dataAttributes = `data-id="${producto.id}" data-nombre="${producto.nombre}" data-precio="${producto.precio}" data-iva="${producto.iva}"`;
                
                if (tipoFactura === 'compra' && producto.precio_venta) {
                  precioVentaHtml = `<td>Gs. ${producto.precio_venta.toLocaleString()}</td>`;
                  dataAttributes += ` data-precio-venta="${producto.precio_venta}"`;
                }
                
                tbody.append(`
                  <tr>
                    <td>${producto.codigo}</td>
                    <td>${producto.nombre}</td>
                    <td>Gs. ${producto.precio.toLocaleString()}</td>
                    ${precioVentaHtml}
                    <td>${producto.stock || 0}</td>
                    <td>
                      <button type="button" class="btn btn-success btn-sm agregar-rapido" 
                              ${dataAttributes}>
                        <i class="bi bi-plus"></i> Agregar
                      </button>
                    </td>
                  </tr>
                `);
              });
              resultadosDiv.show();
            } else {
              tbody.append(`
                <tr>
                  <td colspan="5" class="text-center text-muted">
                    No se encontraron productos
                  </td>
                </tr>
              `);
              resultadosDiv.show();
            }
          })
          .fail(function(xhr, status, error) {
            tbody.empty();
            tbody.append(`
              <tr>
                <td colspan="5" class="text-center text-danger">
                  Error al buscar productos
                </td>
              </tr>
            `);
            resultadosDiv.show();
          });
      } else {
        resultadosDiv.hide();
      }
    });

    // Seleccionar primer producto en carga rápida al presionar Enter
    $('#carga-rapida-search').on('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
      const firstResult = $('#carga-rapida-tbody .agregar-rapido').first();
      if (firstResult.length > 0) {
        firstResult.click();
        }
      }
    });





    // Carga rápida - Agregar producto
    $(document).on('click', '.agregar-rapido', function() {
      const id = $(this).data('id');
      const nombre = $(this).data('nombre');
      const precio = $(this).data('precio');
      const iva = $(this).data('iva');
      const precioVenta = $(this).data('precio-venta');
      const cantidad = parseInt($('#carga-rapida-cantidad').val()) || 1;
      
      console.log('Iniciando agregar producto:', nombre, 'ID:', id);
      
      // Verificar si ya existe el producto en la lista
      let productoExiste = false;
      $('.detalle-row').each(function() {
        const productoId = $(this).find('.producto_id').val();
        if (productoId == id) {
          productoExiste = true;
          // Incrementar cantidad si ya existe
          const cantidadActual = parseInt($(this).find('.cantidad').val()) || 0;
          const nuevaCantidad = cantidadActual + cantidad;
          $(this).find('.cantidad').val(nuevaCantidad);
          console.log('Producto existente, cantidad actualizada a:', nuevaCantidad);
          return false; // break del each
        }
      });
      
      if (productoExiste) {
        // Solo recalcular totales si el producto ya existía
        calcularTotales();
        
        // Mostrar mensaje de cantidad actualizada
        const toast = $(`
          <div class="toast align-items-center text-white bg-info border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
              <div class="toast-body">
                <i class="bi bi-info-circle"></i> Cantidad actualizada: ${nombre}
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
          </div>
        `);
        
        // Crear contenedor de toasts si no existe
        if ($('#toast-container').length === 0) {
          $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>');
        }
        
        $('#toast-container').append(toast);
        const bsToast = new bootstrap.Toast(toast[0]);
        bsToast.show();
      } else {
        console.log('Agregando nuevo producto...');
        
        // Agregar nuevo producto a la factura
        const formCount = parseInt($('#id_detalles-TOTAL_FORMS').val()) || 0;
        console.log('Form count actual:', formCount);
        
        // Verificar que no haya campos duplicados
        const existingProductIds = [];
        $('.producto_id').each(function() {
          const productId = $(this).val();
          if (productId) {
            existingProductIds.push(productId);
          }
        });
        
        if (existingProductIds.includes(id.toString())) {
          console.log('Producto ya existe, actualizando cantidad...');
          // Buscar la fila existente y actualizar cantidad
          const existingRow = $(`.producto_id[value="${id}"]`).closest('.detalle-row');
          const cantidadInput = existingRow.find('.cantidad');
          const cantidadActual = parseInt(cantidadInput.val()) || 0;
          const nuevaCantidad = cantidadActual + parseInt(cantidad);
          cantidadInput.val(nuevaCantidad);
          
          // Recalcular subtotales para esta fila
          const precioInput = existingRow.find('.precio_unitario');
          const precio = parseInt(precioInput.val()) || 0;
          const subtotal = nuevaCantidad * precio;
          
          // Actualizar campos de subtotal
          const ivaProducto = parseInt(existingRow.find('.iva_producto').val()) || 0;
          if (ivaProducto === 5) {
            existingRow.find('.subtotal-5').val(subtotal);
            existingRow.find('.subtotal-10').val(0);
          } else {
            existingRow.find('.subtotal-5').val(0);
            existingRow.find('.subtotal-10').val(subtotal);
          }
          
          // Recalcular totales
          calcularTotales();
          
          // Mostrar mensaje de actualización
          const toast = $(`
            <div class="toast align-items-center text-white bg-info border-0" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="d-flex">
                <div class="toast-body">
                  <i class="bi bi-info-circle"></i> Cantidad actualizada: ${nombre} (${nuevaCantidad})
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
            </div>
          `);
          
          // Crear contenedor de toasts si no existe
          if ($('#toast-container').length === 0) {
            $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>');
          }
          
          $('#toast-container').append(toast);
          const bsToast = new bootstrap.Toast(toast[0]);
          bsToast.show();
          
          // Limpiar búsqueda y salir
          $('#carga-rapida-search').val('');
          $('#carga-rapida-cantidad').val('1');
          $('#resultados-busqueda').hide();
          return;
        }
        
        // Crear nueva fila usando una plantilla HTML
        const tipoFactura = '{{ tipo }}';
        let precioVentaHtml = '';
        let precioVentaInput = '';
        
        if (tipoFactura === 'compra') {
          precioVentaHtml = `
            <td class="col-md-2 text-end">
              <input type="number" name="detalles-${formCount}-precio_venta" class="form-control form-control-sm text-end precio_venta" value="${precioVenta || precio}" min="0" style="width: 100%; direction: rtl;">
            </td>
          `;
        } else {
          // Para facturas de venta, incluir campo oculto con el precio de venta
          precioVentaHtml = `<input type="hidden" name="detalles-${formCount}-precio_venta" value="${precio}">`;
        }
        
        const newRowHtml = `
          <tr class="detalle-row align-middle">
            <td class="col-md-${tipoFactura === 'compra' ? '3' : '4'}">
              <div class="position-relative">
                <input type="text" class="form-control form-control-sm border-0 bg-transparent producto_search" placeholder="Buscar producto..." autocomplete="off" value="${nombre}" readonly style="width: 100%;">
                <input type="hidden" name="detalles-${formCount}-producto" class="producto_id" value="${id}">
                <input type="hidden" name="detalles-${formCount}-iva" class="iva_producto" value="${iva}">
                <div class="producto_results dropdown-menu w-100 position-absolute" style="max-height: 200px; overflow-y: auto; z-index: 1000;"></div>
              </div>
            </td>
            <td class="col-md-2 text-end">
              <input type="number" name="detalles-${formCount}-cantidad" class="form-control form-control-sm cantidad text-end" value="${cantidad}" min="1" style="width: 100%; direction: rtl;">
            </td>
            <td class="col-md-2 text-end">
              <input type="number" name="detalles-${formCount}-precio_unitario" class="form-control form-control-sm text-end precio_unitario" value="${precio}" min="0" style="width: 100%; direction: rtl;">
            </td>
            ${tipoFactura === 'compra' ? precioVentaHtml : ''}
            ${tipoFactura === 'compra' ? `<td class="col-md-2 text-end">
              <input type="text" class="form-control form-control-sm text-end border-0 bg-transparent subtotal-compra" readonly style="width: 100%;" value="${(cantidad * precio).toLocaleString()}">
            </td>` : ''}
            ${tipoFactura === 'venta' ? precioVentaHtml : ''}
            ${tipoFactura !== 'compra' ? `<td class="col-md-2 text-end">
              <input type="text" class="form-control form-control-sm text-end border-0 bg-transparent subtotal-5" readonly style="width: 100%;" value="${iva === 5 ? (cantidad * precio) : 0}">
            </td>` : ''}
            ${tipoFactura !== 'compra' ? `<td class="col-md-2 text-end">
              <input type="text" class="form-control form-control-sm text-end border-0 bg-transparent subtotal-10" readonly style="width: 100%;" value="${iva === 10 ? (cantidad * precio) : 0}">
            </td>` : ''}
          </tr>
        `;
        
        console.log('Creando nueva fila con HTML...');
        
        // Agregar al contenedor
        const container = $('#detalles-container');
        console.log('Contenedor encontrado:', container.length);
        container.append(newRowHtml);
        
        // Actualizar el contador de formularios
      $('#id_detalles-TOTAL_FORMS').val(formCount + 1);
        
        console.log('Fila agregada al DOM. Filas totales después:', $('.detalle-row').length);
      
      // Recalcular totales
      calcularTotales();
      
      // Mostrar mensaje de éxito
      const toast = $(`
        <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              <i class="bi bi-check-circle"></i> Producto agregado: ${nombre}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      `);
      
      // Crear contenedor de toasts si no existe
      if ($('#toast-container').length === 0) {
        $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>');
      }
      
      $('#toast-container').append(toast);
      const bsToast = new bootstrap.Toast(toast[0]);
      bsToast.show();
      }
      
      // Limpiar búsqueda
      $('#carga-rapida-search').val('');
      $('#carga-rapida-cantidad').val('1');
      $('#resultados-busqueda').hide();
      
      // Debug final
      console.log('Producto agregado:', nombre, 'ID:', id, 'Precio:', precio, 'Cantidad:', cantidad);
      console.log('Total de filas al final:', $('.detalle-row').length);
      console.log('Contenido del contenedor:', $('#detalles-container').html());
    });

    // Inicializar cálculos
    calcularTotales();
  });
});
</script>
{% endblock %} 