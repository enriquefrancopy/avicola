{% extends 'base.html' %}
{% load humanize custom_filters %}

{% block title %}Asignar Facturas - Pago #{{ pago.id }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'pagos_proveedores_dashboard' %}">Pagos a Proveedores</a></li>
<li class="breadcrumb-item"><a href="{% url 'pago_proveedor_ver' pago.id %}">Pago #{{ pago.id }}</a></li>
<li class="breadcrumb-item active">Asignar Facturas</li>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h4 class="mb-0">
          <i class="bi bi-plus-circle"></i> Asignar Facturas - Pago #{{ pago.id }}
        </h4>
        <div class="d-flex justify-content-end w-100 ms-3">
          <a href="{% if request.GET.next %}{{ request.GET.next }}{% else %}{% url 'pago_proveedor_ver' pago.id %}{% endif %}" class="btn btn-outline-light">
            <i class="bi bi-arrow-left"></i> Volver
          </a>
        </div>
      </div>
    </div>
    <div class="card-body">
      
      <!-- Información del pago -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card bg-light">
            <div class="card-header bg-info text-white">
              <h6 class="mb-0">
                <i class="bi bi-info-circle"></i> Información del Pago
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-6">
                  <small class="text-muted">ID del Pago:</small><br>
                  <strong>#{{ pago.id }}</strong>
                </div>
                <div class="col-6">
                  <small class="text-muted">Fecha:</small><br>
                  <strong>{{ pago.fecha|date:'d/m/Y H:i' }}</strong>
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-6">
                  <small class="text-muted">Proveedor:</small><br>
                  <strong>{{ pago.proveedor.nombre }}</strong>
                </div>
                <div class="col-6">
                  <small class="text-muted">Tipo:</small><br>
                  <span class="badge bg-info">{{ pago.get_tipo_display }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card bg-success text-white">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="bi bi-calculator"></i> Estado Financiero
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-6">
                  <small class="text-center d-block">Monto Total:</small>
                  <strong class="text-center d-block fs-4">Gs. {{ pago.monto_total|floatformat:0|intcomma_dot }}</strong>
                </div>
                <div class="col-6">
                  <small class="text-center d-block">Asignado:</small>
                  <strong class="text-center d-block fs-4">Gs. {{ pago.monto_asignado|floatformat:0|intcomma_dot }}</strong>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-12">
                  <small class="text-center d-block">Disponible para Asignar:</small>
                  <strong class="text-center d-block fs-4 text-danger">
                    Gs. {{ pago.monto_disponible|floatformat:0|intcomma_dot }}
                  </strong>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Formulario de asignación -->
      <div class="card mb-4">
        <div class="card-header bg-danger text-white">
          <h6 class="mb-0">
            <i class="bi bi-list-check"></i> Asignar Facturas Pendientes
          </h6>
        </div>
        <div class="card-body">
          {% if facturas_pendientes %}
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 
            <strong>Total pendiente del proveedor:</strong> Gs. {{ total_pendiente|floatformat:0|intcomma_dot }}
          </div>
          
          <form method="post">
            {% csrf_token %}
            {{ formset.management_form }}
            
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>Seleccionar</th>
                    <th>Número</th>
                    <th>Fecha</th>
                    <th>Total</th>
                    <th>Pagado</th>
                    <th>Saldo Pendiente</th>
                    <th>Días Vencida</th>
                    <th>Monto a Asignar</th>
                  </tr>
                </thead>
                <tbody>
                  {% for factura in facturas_pendientes %}
                  <tr class="{% if factura.dias_vencida > 30 %}table-danger{% elif factura.dias_vencida > 15 %}table-warning{% endif %}">
                    <td>
                      <div class="form-check">
                        <input class="form-check-input factura-checkbox" type="checkbox" 
                               id="factura_{{ factura.id }}" 
                               data-factura-id="{{ factura.id }}"
                               data-saldo="{{ factura.saldo_pendiente }}">
                        <label class="form-check-label" for="factura_{{ factura.id }}"></label>
                      </div>
                    </td>
                    <td>
                      <a href="{% url 'factura_ver' factura.pk %}" class="text-decoration-none">
                        {{ factura.numero }}
                      </a>
                    </td>
                    <td>{{ factura.fecha|date:'d/m/Y' }}</td>
                    <td class="fw-bold">Gs. {{ factura.total|floatformat:0|intcomma_dot }}</td>
                    <td class="text-success">Gs. {{ factura.total_pagado|floatformat:0|intcomma_dot }}</td>
                    <td class="text-danger fw-bold">Gs. {{ factura.saldo_pendiente|floatformat:0|intcomma_dot }}</td>
                    <td>
                      {% if factura.dias_vencida > 0 %}
                        <span class="badge bg-danger">{{ factura.dias_vencida }} días</span>
                      {% else %}
                        <span class="badge bg-success">Al día</span>
                      {% endif %}
                    </td>
                    <td>
                      <input type="number" class="form-control monto-input" 
                             id="monto_{{ factura.id }}"
                             data-factura-id="{{ factura.id }}"
                             min="1" 
                             max="{{ factura.saldo_pendiente }}"
                             placeholder="0"
                             disabled>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            <div class="row mt-3">
              <div class="col-md-6">
                <div class="alert alert-warning">
                  <strong>Total Asignado:</strong> 
                  <span id="total-asignado">Gs. 0</span> / 
                  <span class="text-success">Gs. {{ pago.monto_disponible|floatformat:0|intcomma_dot }}</span>
                </div>
              </div>
              <div class="col-md-6 d-flex justify-content-end">
                <button type="submit" class="btn btn-success" id="btn-asignar" disabled>
                  <i class="bi bi-check-circle"></i> Asignar Facturas
                </button>
                <a href="{% url 'pago_proveedor_ver' pago.id %}" class="btn btn-secondary">
                  <i class="bi bi-x-circle"></i> Cancelar
                </a>
              </div>
            </div>
          </form>
          
          {% else %}
          <div class="alert alert-info text-center">
            <i class="bi bi-info-circle" style="font-size: 3rem;"></i>
            <h4 class="mt-3">No hay facturas pendientes</h4>
            <p class="mb-3">No hay facturas pendientes disponibles para asignar a este pago.</p>
            <a href="{% url 'pago_proveedor_ver' pago.id %}" class="btn btn-primary">
              <i class="bi bi-arrow-left"></i> Volver al Pago
            </a>
          </div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.factura-checkbox');
    const montoInputs = document.querySelectorAll('.monto-input');
    const totalAsignadoSpan = document.getElementById('total-asignado');
    const btnAsignar = document.getElementById('btn-asignar');
    const montoDisponible = {{ pago.monto_disponible }};
    
    let totalAsignado = 0;
    
    function actualizarTotal() {
        totalAsignado = 0;
        montoInputs.forEach(input => {
            if (input.value && !isNaN(input.value)) {
                totalAsignado += parseInt(input.value);
            }
        });
        
        totalAsignadoSpan.textContent = `Gs. ${totalAsignado.toLocaleString()}`;
        
        // Habilitar/deshabilitar botón
        if (totalAsignado > 0 && totalAsignado <= montoDisponible) {
            btnAsignar.disabled = false;
        } else {
            btnAsignar.disabled = true;
        }
        
        // Cambiar color del total
        if (totalAsignado > montoDisponible) {
            totalAsignadoSpan.className = 'text-danger';
        } else if (totalAsignado > 0) {
            totalAsignadoSpan.className = 'text-success';
        } else {
            totalAsignadoSpan.className = '';
        }
    }
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const facturaId = this.dataset.facturaId;
            const montoInput = document.getElementById(`monto_${facturaId}`);
            
            if (this.checked) {
                montoInput.disabled = false;
                montoInput.value = montoInput.max; // Asignar el saldo completo por defecto
                montoInput.focus();
            } else {
                montoInput.disabled = true;
                montoInput.value = '';
            }
            
            actualizarTotal();
        });
    });
    
    montoInputs.forEach(input => {
        input.addEventListener('input', function() {
            const valor = parseInt(this.value) || 0;
            const max = parseInt(this.max);
            
            if (valor > max) {
                this.value = max;
            }
            
            actualizarTotal();
        });
    });
    
    // Validación del formulario
    document.querySelector('form').addEventListener('submit', function(e) {
        if (totalAsignado > montoDisponible) {
            e.preventDefault();
            alert('El total asignado no puede exceder el monto disponible del pago.');
            return false;
        }
        
        if (totalAsignado === 0) {
            e.preventDefault();
            alert('Debe asignar al menos un monto a una factura.');
            return false;
        }
    });
});
</script>

<style>
.card {
  border-radius: 0.5rem;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.table th {
  border-top: none;
  font-weight: 600;
  font-size: 0.9rem;
}

.table td {
  vertical-align: middle;
  font-size: 0.9rem;
}

.badge {
  font-size: 0.8em;
}

.fs-4 {
  font-size: 1.5rem !important;
}

.form-check-input:checked {
  background-color: #198754;
  border-color: #198754;
}

.monto-input:disabled {
  background-color: #f8f9fa;
  opacity: 0.6;
}
</style>
{% endblock %} 